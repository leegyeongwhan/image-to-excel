<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Excel - 주문 추출</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .file-input {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-input:hover {
            border-color: #007bff;
        }

        .file-input input {
            display: none;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .result-table th {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .usage-card {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .usage-card h3 {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 0.75rem;
        }

        .usage-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .usage-stat {
            font-size: 0.85rem;
            color: #666;
        }

        .usage-stat strong {
            color: #333;
            font-size: 1rem;
        }

        .usage-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 0.75rem;
        }

        .usage-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* 주소 검색 관련 스타일 */
        .address-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .address-text {
            flex: 1;
        }

        .btn-search {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .btn-search:hover {
            background: #545b62;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* 모달 스타일 (juso.go.kr 공식 테마 적용) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #ECECEC;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .search-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            background: #FFFFFF;
            border-radius: 4px;
            padding: 0.25rem;
        }

        .search-input-group input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            font-size: 0.95rem;
            background: #FFFFFF;
            color: #222222;
        }

        .search-input-group input:focus {
            outline: none;
        }

        .search-input-group input::placeholder {
            color: #999;
        }

        .btn-modal-search {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .btn-modal-search:hover {
            background: #0056b3;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #FFFFFF;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:nth-child(odd) {
            background: #FFFFFF;
        }

        .search-result-item:nth-child(even) {
            background: #F8F8F8;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #e8f4ff;
        }

        .search-result-road {
            font-size: 0.95rem;
            color: #333333;
            font-weight: 500;
        }

        .search-result-jibun {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.2rem;
        }

        .search-result-zip {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 0.15rem;
        }

        .search-status {
            padding: 1.5rem;
            text-align: center;
            color: #888;
            font-size: 0.9rem;
        }

        .search-pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #ddd;
        }

        .btn-page {
            background: #FFFFFF;
            border: 1px solid #ddd;
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-page:hover {
            background: #e9ecef;
        }

        .btn-page:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.75rem;
            align-self: flex-end;
        }

        .modal-close:hover {
            background: #545b62;
        }

        /* 네이버지도 fallback */
        .naver-fallback {
            padding: 1rem;
            text-align: center;
            border-top: 1px solid #e9ecef;
            margin-top: 0.5rem;
        }

        .naver-fallback p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.75rem;
        }

        .btn-naver {
            background: #03c75a;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-naver:hover {
            background: #02b351;
        }

        .manual-input-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .manual-input-group input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .manual-input-group input:focus {
            outline: none;
            border-color: #03c75a;
        }

        .btn-manual-apply {
            background: #fd7e14;
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .btn-manual-apply:hover {
            background: #e8590c;
        }

        /* 편집 및 드래그 앤 드롭 스타일 */
        .edit-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 1rem;
            background: transparent;
            transition: all 0.2s;
        }

        .edit-input:hover {
            border-color: #ddd;
            background: #fff;
        }

        .edit-input:focus {
            outline: none;
            border-color: #007bff;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, .25);
        }

        .result-table tbody tr {
            transition: background-color 0.2s;
        }

        .result-table tbody tr.dragging {
            opacity: 0.5;
            background-color: #f8f9fa;
        }

        .result-table tbody tr.drag-over {
            border-top: 2px solid #007bff;
        }

        .drag-handle {
            cursor: grab;
            color: #ccc;
            user-select: none;
            display: inline-block;
            transition: color 0.2s;
            font-size: 1.2rem;
            text-align: center;
        }

        .drag-handle:hover {
            color: #666;
        }

        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Image to Excel</h1>
        <p style="text-align: center; color: #666; margin-bottom: 2rem;">
            메신저 스크린샷에서 주문 정보 추출 (이름, 주소, 전화번호)
        </p>

        <div class="usage-card" id="usageCard" style="display: none;">
            <h3>이번 달 API 사용량</h3>
            <div class="usage-stats">
                <div class="usage-stat">사용: <strong id="usageCount">-</strong>건</div>
                <div class="usage-stat">무료 한도: <strong>1,000</strong>건</div>
                <div class="usage-stat">남은 무료: <strong id="usageFree">-</strong>건</div>
                <div class="usage-stat">예상 요금: <strong id="usageCost">-</strong></div>
            </div>
            <div class="usage-bar">
                <div class="usage-bar-fill" id="usageBarFill" style="width: 0%;"></div>
            </div>
        </div>

        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div class="card">
            <form class="upload-form" method="post" action="/upload" enctype="multipart/form-data" id="uploadForm">
                <input type="hidden" name="existingOrdersJson" id="existingOrdersJsonInput" th:if="${ordersJson}"
                    th:value="${ordersJson}">
                <label class="file-input" id="dropzone">
                    <input type="file" name="files" id="fileInput" accept="image/*" multiple required>
                    <div id="dropzone-text">
                        <p>클릭하거나 이미지를 드래그하세요 (여러 장 선택 가능)</p>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">
                            지원 형식: PNG, JPG, JPEG
                        </p>
                    </div>
                </label>
                <button type="submit" class="btn" id="submitBtn" disabled>분석 시작</button>
            </form>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Google Vision으로 이미지를 분석 중입니다...</p>
                <p style="color: #999; font-size: 0.9rem;">잠시만 기다려주세요.</p>
            </div>
        </div>

        <div th:if="${success}" class="card">
            <h2 style="margin-bottom: 1rem;">분석 결과</h2>
            <div class="alert alert-success">
                <span th:text="${newFileCount ?: 0}">0</span>개의 이미지를 분석하여,
                현재 총 <strong th:text="${#lists.size(orders)}">0</strong>건의 주문 정보가 목록에 있습니다.
            </div>

            <table class="result-table" id="resultTable">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align: center;">순서</th>
                        <th style="width: 50px;">No.</th>
                        <th>이름</th>
                        <th>주소</th>
                        <th>전화번호</th>
                        <th style="width: 60px;">관리</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                    <tr th:each="order, stat : ${orders}" th:attr="data-index=${stat.index}" draggable="true"
                        ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)"
                        ondragend="handleDragEnd(event)">
                        <td style="text-align: center;"><span class="drag-handle" title="드래그하여 순서 변경">☰</span></td>
                        <td class="row-num" th:text="${stat.index + 1}">1</td>
                        <td>
                            <input type="text" class="edit-input" th:value="${order.name}"
                                th:attr="data-index=${stat.index}, data-field='name'" onchange="updateOrderData(this)">
                        </td>
                        <td>
                            <div class="address-cell">
                                <span class="address-text" th:text="${order.address}">Address</span>
                                <button type="button" class="btn-search"
                                    th:attr="data-index=${stat.index},data-address=${order.address}"
                                    onclick="openAddressSearch(this)">
                                    주소검색
                                </button>
                            </div>
                        </td>
                        <td>
                            <input type="text" class="edit-input" th:value="${order.phone}"
                                th:attr="data-index=${stat.index}, data-field='phone'" onchange="updateOrderData(this)">
                        </td>
                        <td>
                            <button type="button" class="btn-delete" th:attr="data-index=${stat.index}"
                                onclick="deleteOrder(this)">삭제</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <form method="post" action="/download" class="actions" id="downloadForm">
                <input type="hidden" name="ordersJson" id="ordersJsonInput" th:value="${ordersJson}">
                <button type="submit" class="btn btn-success">Excel 다운로드</button>
                <a href="/" class="btn" style="text-decoration: none;">새로 업로드</a>
            </form>
        </div>
    </div>

    <!-- 주소 검색 모달 -->
    <div class="modal-overlay" id="addressModal">
        <div class="modal">
            <h3>도로명주소 검색</h3>
            <div class="search-input-group">
                <input type="text" id="addressSearchInput" placeholder="도로명을 입력하세요 (예: 흑석로)"
                    onkeydown="if(event.key==='Enter') searchAddress()">
                <button type="button" class="btn-modal-search" onclick="searchAddress()">검색</button>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-status">도로명을 입력하고 검색 버튼을 눌러주세요.</div>
            </div>
            <div class="search-pagination" id="searchPagination" style="display: none;">
                <button type="button" class="btn-page" id="btnPrevPage" onclick="changePage(-1)">이전</button>
                <span id="pageInfo" style="font-size: 0.85rem; color: #666; line-height: 1.8;"></span>
                <button type="button" class="btn-page" id="btnNextPage" onclick="changePage(1)">다음</button>
            </div>
            <button type="button" class="modal-close" onclick="closeAddressSearch()">닫기</button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitBtn');
        const dropzoneText = document.getElementById('dropzone-text');
        const uploadForm = document.getElementById('uploadForm');
        const loadingIndicator = document.getElementById('loadingIndicator');

        let isSorting = false;
        fileInput.addEventListener('change', function () {
            if (isSorting) return;
            if (this.files.length > 0) {
                try {
                    isSorting = true;
                    // 첫 번째로 다운받은 파일(생성/수정일이 가장 오래된 파일)이 먼저 오도록 정렬 (오름차순)
                    const dt = new DataTransfer();
                    const sortedFiles = Array.from(this.files).sort((a, b) => a.lastModified - b.lastModified);
                    sortedFiles.forEach(f => dt.items.add(f));
                    this.files = dt.files;
                } catch (err) {
                    console.error('File sort failed:', err);
                } finally {
                    isSorting = false;
                }

                const count = this.files.length;
                const names = Array.from(this.files).map(f => f.name).join(', ');
                dropzoneText.innerHTML =
                    '<p style="color: #28a745;">' + count + '개 파일 선택됨</p>' +
                    '<p style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">' + names + '</p>';
                submitBtn.disabled = false;
            }
        });

        uploadForm.addEventListener('submit', function () {
            submitBtn.disabled = true;
            submitBtn.textContent = '처리 중...';
            loadingIndicator.classList.add('active');
        });

        fetch('/api/usage')
            .then(res => res.json())
            .then(data => {
                document.getElementById('usageCard').style.display = 'block';
                document.getElementById('usageCount').textContent = data.callCount.toLocaleString();
                document.getElementById('usageFree').textContent = data.freeRemaining.toLocaleString();
                document.getElementById('usageCost').textContent = '$' + data.estimatedCost.toFixed(2);

                const percent = Math.min(100, (data.callCount / data.freeLimit) * 100);
                const bar = document.getElementById('usageBarFill');
                bar.style.width = percent + '%';
                bar.style.background = percent >= 100 ? '#dc3545' : percent >= 80 ? '#ffc107' : '#28a745';
            })
            .catch(() => { });

        const dropzone = document.getElementById('dropzone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropzone.addEventListener(event, e => { e.preventDefault(); e.stopPropagation(); });
        });
        dropzone.addEventListener('dragover', () => dropzone.style.borderColor = '#007bff');
        dropzone.addEventListener('dragleave', () => dropzone.style.borderColor = '#ddd');
        dropzone.addEventListener('drop', e => {
            dropzone.style.borderColor = '#ddd';
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        });

        // === 주소 검색 기능 ===
        let currentSearchIndex = -1;
        let currentPage = 1;
        let currentKeyword = '';
        let currentTotalCount = 0;
        const PAGE_SIZE = 10;

        function openAddressSearch(btn) {
            currentSearchIndex = parseInt(btn.getAttribute('data-index'));
            const address = btn.getAttribute('data-address') || '';
            document.getElementById('addressSearchInput').value = address;
            document.getElementById('searchResults').innerHTML =
                '<div class="search-status">도로명을 입력하고 검색 버튼을 눌러주세요.</div>';
            document.getElementById('searchPagination').style.display = 'none';
            document.getElementById('addressModal').classList.add('active');
            document.getElementById('addressSearchInput').focus();
        }

        function closeAddressSearch() {
            document.getElementById('addressModal').classList.remove('active');
            currentSearchIndex = -1;
        }

        // 모달 바깥 클릭 시 닫기
        document.getElementById('addressModal').addEventListener('click', function (e) {
            if (e.target === this) closeAddressSearch();
        });

        function searchAddress(page) {
            const keyword = document.getElementById('addressSearchInput').value.trim();
            if (!keyword) return;

            currentKeyword = keyword;
            currentPage = page || 1;

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="search-status">검색 중...</div>';
            document.getElementById('searchPagination').style.display = 'none';

            fetch('/api/address/search?keyword=' + encodeURIComponent(keyword) + '&page=' + currentPage)
                .then(res => res.json())
                .then(data => {
                    currentTotalCount = data.totalCount;
                    renderSearchResults(data);
                })
                .catch(() => {
                    resultsDiv.innerHTML = '<div class="search-status">검색 중 오류가 발생했습니다.</div>';
                });
        }

        function renderSearchResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            const keyword = currentKeyword;

            if (!data.addresses || data.addresses.length === 0) {
                const naverUrl = 'https://map.naver.com/p/search/' + encodeURIComponent(keyword);
                resultsDiv.innerHTML =
                    '<div class="search-status">도로명주소 검색 결과가 없습니다.</div>' +
                    '<div class="naver-fallback">' +
                    '<p>시골 지역이나 상세 주소는 네이버지도에서 검색해보세요.</p>' +
                    '<a class="btn-naver" href="' + naverUrl + '" target="_blank" rel="noopener">' +
                    '네이버지도에서 검색' +
                    '</a>' +
                    '<div class="manual-input-group">' +
                    '<input type="text" id="manualAddressInput" ' +
                    'placeholder="네이버지도에서 찾은 주소를 입력하세요"' +
                    ' onkeydown="if(event.key===\'Enter\') applyManualAddress()">' +
                    '<button type="button" class="btn-manual-apply" onclick="applyManualAddress()">적용</button>' +
                    '</div>' +
                    '</div>';
                document.getElementById('searchPagination').style.display = 'none';
                return;
            }

            let html = '';
            data.addresses.forEach(addr => {
                html += '<div class="search-result-item" onclick="selectAddress(this)" ' +
                    'data-road="' + escapeHtml(addr.roadAddr) + '">' +
                    '<div class="search-result-road">' + escapeHtml(addr.roadAddr) + '</div>' +
                    '<div class="search-result-jibun">[지번] ' + escapeHtml(addr.jibunAddr) + '</div>' +
                    '<div class="search-result-zip">[우편번호] ' + escapeHtml(addr.zipNo) + '</div>' +
                    '</div>';
            });

            // 검색 결과가 있어도 네이버지도 링크 제공
            const naverUrl = 'https://map.naver.com/p/search/' + encodeURIComponent(keyword);
            html += '<div class="naver-fallback">' +
                '<p>원하는 주소가 없나요?</p>' +
                '<a class="btn-naver" href="' + naverUrl + '" target="_blank" rel="noopener">' +
                '네이버지도에서 검색' +
                '</a>' +
                '<div class="manual-input-group">' +
                '<input type="text" id="manualAddressInput" ' +
                'placeholder="주소를 직접 입력하세요"' +
                ' onkeydown="if(event.key===\'Enter\') applyManualAddress()">' +
                '<button type="button" class="btn-manual-apply" onclick="applyManualAddress()">적용</button>' +
                '</div>' +
                '</div>';

            resultsDiv.innerHTML = html;

            // 페이지네이션
            const totalPages = Math.ceil(currentTotalCount / PAGE_SIZE);
            if (totalPages > 1) {
                document.getElementById('searchPagination').style.display = 'flex';
                document.getElementById('pageInfo').textContent =
                    currentPage + ' / ' + totalPages + ' (총 ' + currentTotalCount + '건)';
                document.getElementById('btnPrevPage').disabled = (currentPage <= 1);
                document.getElementById('btnNextPage').disabled = (currentPage >= totalPages);
            } else {
                document.getElementById('searchPagination').style.display = 'none';
            }
        }

        function changePage(delta) {
            searchAddress(currentPage + delta);
        }

        function selectAddress(item) {
            const roadAddr = item.getAttribute('data-road');
            if (currentSearchIndex < 0) return;

            // 테이블 UI 업데이트
            const row = document.querySelector('tr[data-index="' + currentSearchIndex + '"]');
            if (row) {
                const addressText = row.querySelector('.address-text');
                const searchBtn = row.querySelector('.btn-search');
                if (addressText) addressText.textContent = roadAddr;
                if (searchBtn) searchBtn.setAttribute('data-address', roadAddr);
            }

            // ordersJson 업데이트
            const jsonInput = document.getElementById('ordersJsonInput');
            if (jsonInput) {
                try {
                    const orders = JSON.parse(jsonInput.value);
                    if (orders[currentSearchIndex]) {
                        orders[currentSearchIndex].address = roadAddr;
                        jsonInput.value = JSON.stringify(orders);
                    }
                } catch (e) {
                    console.error('ordersJson 업데이트 실패:', e);
                }
            }

            closeAddressSearch();
        }

        function applyManualAddress() {
            const input = document.getElementById('manualAddressInput');
            if (!input) return;
            const addr = input.value.trim();
            if (!addr) {
                input.focus();
                return;
            }
            if (currentSearchIndex < 0) return;

            // 테이블 UI 업데이트
            const row = document.querySelector('tr[data-index="' + currentSearchIndex + '"]');
            if (row) {
                const addressText = row.querySelector('.address-text');
                const searchBtn = row.querySelector('.btn-search');
                if (addressText) addressText.textContent = addr;
                if (searchBtn) searchBtn.setAttribute('data-address', addr);
            }

            // ordersJson 업데이트
            const jsonInput = document.getElementById('ordersJsonInput');
            if (jsonInput) {
                try {
                    const orders = JSON.parse(jsonInput.value);
                    if (orders[currentSearchIndex]) {
                        orders[currentSearchIndex].address = addr;
                        jsonInput.value = JSON.stringify(orders);
                    }
                } catch (e) {
                    console.error('ordersJson 업데이트 실패:', e);
                }
            }

            closeAddressSearch();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function deleteOrder(btn) {
            if (!confirm('이 주문 정보를 목록에서 삭제하시겠습니까?')) return;
            const index = parseInt(btn.getAttribute('data-index'));
            const jsonInput = document.getElementById('ordersJsonInput');
            const existingOrdersJsonInput = document.getElementById('existingOrdersJsonInput');

            if (jsonInput) {
                try {
                    let orders = JSON.parse(jsonInput.value);
                    orders.splice(index, 1);
                    const newJson = JSON.stringify(orders);

                    jsonInput.value = newJson;
                    if (existingOrdersJsonInput) {
                        existingOrdersJsonInput.value = newJson;
                    }

                    const row = document.querySelector('tr[data-index="' + index + '"]');
                    if (row) row.remove();

                    const tbody = document.getElementById('resultTableBody');

                    reindexRows();

                    const totalStrong = document.querySelector('.alert-success strong');
                    if (totalStrong) totalStrong.textContent = orders.length;

                    if (orders.length === 0) {
                        document.querySelector('.result-table').closest('.card').style.display = 'none';
                        if (existingOrdersJsonInput) existingOrdersJsonInput.remove();
                    }
                } catch (e) {
                    console.error('삭제 중 오류:', e);
                    alert('삭제 중 오류가 발생했습니다.');
                }
            }
        }

        // === 데이터 수정 로직 ===
        function updateOrderData(input) {
            const index = parseInt(input.getAttribute('data-index'));
            const field = input.getAttribute('data-field');
            const value = input.value.trim();

            const jsonInput = document.getElementById('ordersJsonInput');
            const existingOrdersJsonInput = document.getElementById('existingOrdersJsonInput');

            if (jsonInput) {
                try {
                    const orders = JSON.parse(jsonInput.value);
                    if (orders[index]) {
                        orders[index][field] = value;
                        const newJson = JSON.stringify(orders);
                        jsonInput.value = newJson;
                        if (existingOrdersJsonInput) {
                            existingOrdersJsonInput.value = newJson;
                        }
                    }
                } catch (e) {
                    console.error('Data update failed:', e);
                }
            }
        }

        // === 드래그 앤 드롭 로직 ===
        let draggedRowIndex = null;

        function handleDragStart(e) {
            const tr = e.target.closest('tr');
            draggedRowIndex = parseInt(tr.getAttribute('data-index'));
            tr.classList.add('dragging');

            // 필수 드래그 데이터 설정
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedRowIndex);

            // 빈 이미지 설정 시 drag image를 감추지 못해 약간 깜빡일 수 있으므로 그대로 두되, 
            // 원하는 경우 event.dataTransfer.setDragImage() 사용 가능
        }

        function handleDragOver(e) {
            e.preventDefault(); // drop 허용
            e.dataTransfer.dropEffect = 'move';

            const tr = e.target.closest('tr');
            if (tr && !tr.classList.contains('dragging')) {
                tr.classList.add('drag-over');
            }
            return false;
        }

        function handleDragLeave(e) {
            const tr = e.target.closest('tr');
            if (tr) {
                tr.classList.remove('drag-over');
            }
        }

        function handleDragEnd(e) {
            const tr = e.target.closest('tr');
            if (tr) {
                tr.classList.remove('dragging');
            }
            document.querySelectorAll('.result-table tbody tr').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const tr = e.target.closest('tr');
            if (tr) {
                tr.classList.remove('drag-over');
            }

            if (!tr) return false;

            const dropTargetIndex = parseInt(tr.getAttribute('data-index'));

            if (draggedRowIndex === null || dropTargetIndex === null || draggedRowIndex === dropTargetIndex || isNaN(draggedRowIndex) || isNaN(dropTargetIndex)) {
                draggedRowIndex = null;
                return false;
            }

            // 배열 데이터 순서 변경
            const jsonInput = document.getElementById('ordersJsonInput');
            const existingOrdersJsonInput = document.getElementById('existingOrdersJsonInput');

            if (jsonInput) {
                try {
                    let orders = JSON.parse(jsonInput.value);

                    // 이동할 항목 추출 및 새 위치에 삽입
                    const draggedItem = orders.splice(draggedRowIndex, 1)[0];
                    orders.splice(dropTargetIndex, 0, draggedItem);

                    const newJson = JSON.stringify(orders);
                    jsonInput.value = newJson;
                    if (existingOrdersJsonInput) {
                        existingOrdersJsonInput.value = newJson;
                    }

                    // DOM 행 순서 변경
                    const tbody = document.getElementById('resultTableBody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const draggedRow = rows.find(r => parseInt(r.getAttribute('data-index')) === parseInt(draggedRowIndex));
                    const targetRow = rows.find(r => parseInt(r.getAttribute('data-index')) === parseInt(dropTargetIndex));

                    if (draggedRow && targetRow) {
                        if (draggedRowIndex < dropTargetIndex) {
                            targetRow.after(draggedRow);
                        } else {
                            targetRow.before(draggedRow);
                        }

                        // 인덱스 및 번호 재정렬
                        reindexRows();
                    }

                } catch (err) {
                    console.error('Drop handling failed:', err);
                }
            }
            draggedRowIndex = null;
            return false;
        }

        function reindexRows() {
            const tbody = document.getElementById('resultTableBody');
            Array.from(tbody.querySelectorAll('tr')).forEach((tr, i) => {
                tr.setAttribute('data-index', i);

                const numCell = tr.querySelector('.row-num');
                if (numCell) numCell.textContent = i + 1;

                // 입력 필드 인덱스 업데이트
                tr.querySelectorAll('.edit-input').forEach(input => {
                    input.setAttribute('data-index', i);
                });

                // 주소 검색 버튼 인덱스 업데이트
                const searchBtn = tr.querySelector('.btn-search');
                if (searchBtn) searchBtn.setAttribute('data-index', i);

                // 삭제 버튼 인덱스 업데이트
                const delBtn = tr.querySelector('.btn-delete');
                if (delBtn) delBtn.setAttribute('data-index', i);
            });
        }
    </script>
</body>

</html>
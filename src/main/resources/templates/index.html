<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Excel - 주문 추출</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 2rem; text-align: center; }
        .card {
            background: white; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem; margin-bottom: 1.5rem;
        }
        .upload-form { display: flex; flex-direction: column; gap: 1rem; }
        .file-input {
            border: 2px dashed #ddd; border-radius: 8px;
            padding: 2rem; text-align: center; cursor: pointer;
            transition: border-color 0.3s;
        }
        .file-input:hover { border-color: #007bff; }
        .file-input input { display: none; }
        .btn {
            background: #007bff; color: white; border: none;
            padding: 0.75rem 1.5rem; border-radius: 4px;
            cursor: pointer; font-size: 1rem; transition: background 0.3s;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .alert { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .result-table th, .result-table td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        .result-table th { background: #f8f9fa; }
        .actions { display: flex; gap: 1rem; margin-top: 1rem; }
        .loading { display: none; text-align: center; padding: 2rem; }
        .loading.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .usage-card {
            background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;
            padding: 1.25rem; margin-bottom: 1.5rem;
        }
        .usage-card h3 { font-size: 0.95rem; color: #495057; margin-bottom: 0.75rem; }
        .usage-stats { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .usage-stat { font-size: 0.85rem; color: #666; }
        .usage-stat strong { color: #333; font-size: 1rem; }
        .usage-bar { height: 6px; background: #e9ecef; border-radius: 3px; margin-top: 0.75rem; }
        .usage-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image to Excel</h1>
        <p style="text-align: center; color: #666; margin-bottom: 2rem;">
            메신저 스크린샷에서 주문 정보 추출 (이름, 주소, 전화번호)
        </p>

        <div class="usage-card" id="usageCard" style="display: none;">
            <h3>이번 달 API 사용량</h3>
            <div class="usage-stats">
                <div class="usage-stat">사용: <strong id="usageCount">-</strong>건</div>
                <div class="usage-stat">무료 한도: <strong>1,000</strong>건</div>
                <div class="usage-stat">남은 무료: <strong id="usageFree">-</strong>건</div>
                <div class="usage-stat">예상 요금: <strong id="usageCost">-</strong></div>
            </div>
            <div class="usage-bar">
                <div class="usage-bar-fill" id="usageBarFill" style="width: 0%;"></div>
            </div>
        </div>

        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div class="card">
            <form class="upload-form" method="post" action="/upload"
                  enctype="multipart/form-data" id="uploadForm">
                <label class="file-input" id="dropzone">
                    <input type="file" name="files" id="fileInput"
                           accept="image/*" multiple required>
                    <div id="dropzone-text">
                        <p>클릭하거나 이미지를 드래그하세요 (여러 장 선택 가능)</p>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">
                            지원 형식: PNG, JPG, JPEG
                        </p>
                    </div>
                </label>
                <button type="submit" class="btn" id="submitBtn" disabled>분석 시작</button>
            </form>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Google Vision으로 이미지를 분석 중입니다...</p>
                <p style="color: #999; font-size: 0.9rem;">잠시만 기다려주세요.</p>
            </div>
        </div>

        <div th:if="${success}" class="card">
            <h2 style="margin-bottom: 1rem;">분석 결과</h2>
            <div class="alert alert-success">
                <span th:text="${fileCount}">0</span>개의 이미지에서
                <span th:text="${#lists.size(orders)}">0</span>건의 주문 정보를 추출했습니다.
            </div>

            <table class="result-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th>이름</th>
                        <th>주소</th>
                        <th>전화번호</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order, stat : ${orders}">
                        <td th:text="${stat.index + 1}">1</td>
                        <td th:text="${order.name}">Name</td>
                        <td th:text="${order.address}">Address</td>
                        <td th:text="${order.phone}">Phone</td>
                    </tr>
                </tbody>
            </table>

            <form method="post" action="/download" class="actions">
                <input type="hidden" name="ordersJson" th:value="${ordersJson}">
                <button type="submit" class="btn btn-success">Excel 다운로드</button>
                <a href="/" class="btn" style="text-decoration: none;">새로 업로드</a>
            </form>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitBtn');
        const dropzoneText = document.getElementById('dropzone-text');
        const uploadForm = document.getElementById('uploadForm');
        const loadingIndicator = document.getElementById('loadingIndicator');

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const count = this.files.length;
                const names = Array.from(this.files).map(f => f.name).join(', ');
                dropzoneText.innerHTML =
                    '<p style="color: #28a745;">' + count + '개 파일 선택됨</p>' +
                    '<p style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">' + names + '</p>';
                submitBtn.disabled = false;
            }
        });

        uploadForm.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.textContent = '처리 중...';
            loadingIndicator.classList.add('active');
        });

        fetch('/api/usage')
            .then(res => res.json())
            .then(data => {
                document.getElementById('usageCard').style.display = 'block';
                document.getElementById('usageCount').textContent = data.callCount.toLocaleString();
                document.getElementById('usageFree').textContent = data.freeRemaining.toLocaleString();
                document.getElementById('usageCost').textContent = '$' + data.estimatedCost.toFixed(2);

                const percent = Math.min(100, (data.callCount / data.freeLimit) * 100);
                const bar = document.getElementById('usageBarFill');
                bar.style.width = percent + '%';
                bar.style.background = percent >= 100 ? '#dc3545' : percent >= 80 ? '#ffc107' : '#28a745';
            })
            .catch(() => {});

        const dropzone = document.getElementById('dropzone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropzone.addEventListener(event, e => { e.preventDefault(); e.stopPropagation(); });
        });
        dropzone.addEventListener('dragover', () => dropzone.style.borderColor = '#007bff');
        dropzone.addEventListener('dragleave', () => dropzone.style.borderColor = '#ddd');
        dropzone.addEventListener('drop', e => {
            dropzone.style.borderColor = '#ddd';
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html>
